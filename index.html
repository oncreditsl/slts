<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Short Leave Tracking System</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>.kbd{border:1px solid #e5e7eb;border-bottom-width:3px;border-radius:.375rem;padding:.125rem .375rem;font-size:.75rem}</style>
</head>
<body class="bg-gray-100 font-sans p-4 min-h-screen flex items-center justify-center">
<div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-md transition-all duration-300 transform scale-0 opacity-0"></div>

<div class="container mx-auto p-6 md:p-8 bg-white rounded-lg shadow-xl max-w-5xl">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Short Leave Tracking System</h1>
      <p class="text-gray-500 text-sm">Staff lists & records saved to a single JSON file in your GitHub repo.</p>
    </div>
    <div class="flex items-center gap-3">
      <span id="syncBadge" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 border">Not connected</span>
      <button id="connectNow" class="bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700">Connect</button>
      <button id="openSettings" class="bg-gray-800 text-white px-4 py-2 rounded-md font-semibold hover:bg-black">Settings</button>
    </div>
  </div>

  <div id="settingsPanel" class="hidden mb-6 border rounded-lg">
    <div class="p-4 bg-gray-50 border-b flex items-center justify-between">
      <h2 class="text-lg font-semibold">GitHub Settings</h2>
      <button id="closeSettings" class="text-sm text-gray-600 hover:text-gray-900">Close</button>
    </div>
    <form id="settingsForm" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Owner / Org</label>
        <input id="ghOwner" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="e.g. your-username" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Repository</label>
        <input id="ghRepo" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="e.g. short-leave-tracker" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Branch</label>
        <input id="ghBranch" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="e.g. main" value="main" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">App data file path</label>
        <input id="ghPath" class="mt-1 w-full rounded-md border-gray-300 p-2" value="data/app_data.json" required>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">GitHub Personal Access Token (PAT)</label>
        <input id="ghToken" type="password" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="Fine-grained token with contents:read,contents:write" required>
        <p class="text-xs text-gray-500 mt-1">Token is kept in <b>sessionStorage</b> and cleared on tab close.</p>
      </div>
      <div class="md:col-span-2 flex justify-end gap-2">
        <button type="button" id="testConnection" class="px-4 py-2 rounded bg-gray-100 border hover:bg-gray-200">Test</button>
        <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Save Settings</button>
      </div>
    </form>
  </div>

  <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add a New Leave Record</h2>
    <form id="leaveForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="department" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select --</option>
          <option>Verification</option>
          <option>Collection</option>
          <option>CS|TS|RPD</option>
          <option>Quality Control</option>
          <option>Finance</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <select id="name" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select --</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date</label>
        <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Duration</label>
        <div class="mt-2 space-y-2">
          <label class="flex items-center"><input name="leaveDuration" type="radio" value="1 hour" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">1 hour</span></label>
          <label class="flex items-center"><input name="leaveDuration" type="radio" value="2 hours" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">2 hours</span></label>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Shift</label>
        <div class="mt-2 space-y-2">
          <label class="flex items-center"><input name="shift" type="radio" value="Morning" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">Morning</span></label>
          <label class="flex items-center"><input name="shift" type="radio" value="Evening" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">Evening</span></label>
        </div>
      </div>
      <div class="col-span-1 md:col-span-3 flex flex-wrap justify-end gap-2">
        <button type="button" id="exportButton" class="bg-gray-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-gray-700">Export CSV</button>
        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-indigo-700">Add Record</button>
      </div>
    </form>
  </div>

  <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 px-2">Leave Records</h2>
    <table class="w-full text-sm text-left text-gray-700">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50">
        <tr>
          <th class="px-6 py-3">Record ID</th>
          <th class="px-6 py-3">Department</th>
          <th class="px-6 py-3">Name</th>
          <th class="px-6 py-3">Date</th>
          <th class="px-6 py-3">Duration</th>
          <th class="px-6 py-3">Shift</th>
        </tr>
      </thead>
      <tbody id="leaveTableBody"></tbody>
    </table>
  </div>

  <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Delete a Record</h2>
    <p class="text-sm text-gray-500 mb-4">Use the Record ID from the table above.</p>
    <form id="deleteForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label class="block text-sm font-medium text-gray-700">Record ID</label><input id="deleteRecordId" class="mt-1 w-full rounded-md border-gray-300 p-2" required></div>
      <div><label class="block text-sm font-medium text-gray-700">Username</label><input id="deleteUsername" class="mt-1 w-full rounded-md border-gray-300 p-2" required></div>
      <div><label class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="deletePassword" class="mt-1 w-full rounded-md border-gray-300 p-2" required></div>
      <div class="col-span-1 md:col-span-3 flex justify-end"><button class="bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700">Delete Record</button></div>
    </form>
  </div>

  <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add a New Staff Member</h2>
    <form id="addStaffForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="addStaffDepartment" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select --</option>
          <option>Verification</option>
          <option>Collection</option>
          <option>CS|TS|RPD</option>
          <option>Quality Control</option>
          <option>Finance</option>
        </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700">Staff Name</label><input id="newStaffName" class="mt-1 block w-full rounded-md border-gray-300 p-2" required></div>
      <div class="col-span-1 md:col-span-3 flex justify-end"><button class="bg-gray-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-gray-700">Add Staff</button></div>
    </form>
    <p class="text-xs text-gray-500 mt-3">Staff lists sync to GitHub. Existing leave records stay unchanged.</p>
  </div>

  <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Remove a Staff Member</h2>
    <form id="removeStaffForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="removeStaffDepartment" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select --</option>
          <option>Verification</option>
          <option>Collection</option>
          <option>CS|TS|RPD</option>
          <option>Quality Control</option>
          <option>Finance</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Staff Name</label>
        <select id="removeStaffName" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select a department first --</option>
        </select>
      </div>
      <div class="col-span-1 md:col-span-3 flex justify-end"><button class="bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700">Remove Staff</button></div>
    </form>
    <p class="text-xs text-gray-500 mt-3">Removal updates the staff list only; it doesn’t delete past records.</p>
  </div>
</div>

<div id="confirmModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div id="modalOverlay" class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-black/5">
      <div class="px-6 pt-6">
        <div class="flex items-start gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mt-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 5v6h-2V7h2zm0 8v2h-2v-2h2z"/></svg>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Remove Staff Member?</h3>
            <p class="mt-1 text-sm text-gray-600">You’re about to remove <span id="modalName" class="font-semibold text-gray-900"></span> from <span id="modalDept" class="font-semibold text-gray-900"></span>.</p>
            <p class="mt-1 text-xs text-gray-500">This will not delete existing leave records.</p>
          </div>
        </div>
      </div>
      <div class="px-6 pb-6 pt-4 flex items-center justify-end gap-2">
        <button id="modalCancel" class="px-4 py-2 rounded-md border bg-white text-gray-700 hover:bg-gray-50">Cancel</button>
        <button id="modalConfirm" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Remove</button>
      </div>
    </div>
  </div>
</div>

<script>
const K={owner:'gh.owner',repo:'gh.repo',path:'gh.path',branch:'gh.branch',token:'gh.token'};
const q=(id)=>document.getElementById(id);
function toast(msg,type='info'){const el=q('messageBox');const base='fixed top-4 left-1/2 -translate-x-1/2 z-50',look='px-4 py-2 rounded-md text-sm text-white shadow-lg border transition-all duration-300 transform max-w-[90vw]',col=type==='error'?'bg-red-600 border-red-700':'bg-green-600 border-green-700';el.textContent=msg;el.classList.remove('opacity-0','scale-0');el.className=`${base} ${look} ${col} opacity-100 scale-100`;clearTimeout(toast._t);toast._t=setTimeout(()=>el.classList.add('opacity-0','scale-0'),3000)}
function saveCfg(c){sessionStorage.setItem(K.owner,c.owner||'');sessionStorage.setItem(K.repo,c.repo||'');sessionStorage.setItem(K.path,c.path||'');sessionStorage.setItem(K.branch,c.branch||'');sessionStorage.setItem(K.token,c.token||'')}
function readCfg(){return{owner:sessionStorage.getItem(K.owner)||'',repo:sessionStorage.getItem(K.repo)||'',path:sessionStorage.getItem(K.path)||'data/app_data.json',branch:sessionStorage.getItem(K.branch)||'main',token:sessionStorage.getItem(K.token)||''}}
function badge(t,c){const el=q('syncBadge');el.textContent=t;el.className=`text-xs px-2 py-1 rounded border ${c}`}
function toB64(s){const u=new TextEncoder().encode(s);let b='';u.forEach(x=>b+=String.fromCharCode(x));return btoa(b)}
function fromB64(b){const bin=atob(b);const a=Uint8Array.from(bin,c=>c.charCodeAt(0));return new TextDecoder().decode(a)}
function ghH(tok){return{'Accept':'application/vnd.github+json','Authorization':`Bearer ${tok}`,'X-GitHub-Api-Version':'2022-11-28','Content-Type':'application/json'}}
async function ghRepo({owner,repo,token}){const r=await fetch(`https://api.github.com/repos/${owner}/${repo}`,{headers:ghH(token)});if(!r.ok)throw new Error(`Repo check failed: ${r.status}`);return r.json()}
async function ghBranch({owner,repo,branch,token}){const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${encodeURIComponent(branch)}`,{headers:ghH(token)});if(r.status===404)return null;if(!r.ok)throw new Error(`Branch check failed: ${r.status}`);return r.json()}
async function diagnose(c){try{const rp=await ghRepo(c);const br=await ghBranch(c);if(!br)return{ok:false,msg:`404: Branch "${c.branch}" not found. Repo default branch is "${rp.default_branch}".`};return{ok:true,defaultBranch:rp.default_branch}}catch(e){return{ok:false,msg:'404: Repo not found or token has no access (private repos return 404). Check Owner/Repo, PAT, org SSO.'}}}
async function ghGet({owner,repo,path,branch,token}){const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`,{headers:ghH(token)});if(r.status===404)return{contentText:null,sha:null};if(!r.ok)throw new Error(`GET failed: ${r.status}`);const j=await r.json();return{contentText:fromB64(j.content||''),sha:j.sha}}
async function ghPut(c,text,sha,msg='Update app data'){
  const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encodeURIComponent(c.path)}`;
  const body=(x)=>JSON.stringify({message:`${msg} (${new Date().toISOString()})`,content:toB64(text),branch:c.branch,...(x?{sha:x}:{})});
  const attempt=async(x)=>{
    const r=await fetch(url,{method:'PUT',headers:ghH(c.token),body:body(x)});
    if(r.ok)return(await r.json()).content.sha;
    const t=await r.text();
    if(r.status===409)return{conflict:true,txt:t};
    if(r.status===403)throw new Error(`PUT 403 (token/branch). ${t}`);
    if(r.status===404)throw new Error(`PUT 404 (repo/branch or access). ${t}`);
    if(r.status===422)throw new Error(`PUT 422 (path/encoding). ${t}`);
    throw new Error(`PUT ${r.status} ${t}`)
  };
  const a=await attempt(sha);
  if(typeof a==='string')return a;
  if(a&&a.conflict){
    const {sha:latest}=await ghGet(c);
    if(!latest)throw new Error('Conflict but no latest SHA.');
    const b=await attempt(latest);
    if(typeof b==='string')return b;
    throw new Error('Conflict persisted.')
  }
  throw new Error('Unexpected save flow')
}

// --- UPDATED: defaults now include Finance ---
const defaults={
  'Verification':['Ruwanjana Dissanayaka','Arunali Vihanga','Praveen Thrindu','Rahul Krishnan'],
  'Collection':['Dilshan Madhuwantha','Nimesh Perera','Iresha Dilhani','Asanka Nash'],
  'CS|TS|RPD':['Gayanthi Madhuwanthi','Noyeli Yalindi','Fathima Sasmiya','Jegan Gayathri'],
  'Quality Control':['Amanda Udeshani','Samadhi Lanka','Kaveesha Dias','Sandhanam Kavishanth'],
  'Finance':[]
};

let SHA=null; let data={staff:defaults,records:[]};

// Ensure keys from defaults always exist on loaded staff
function withDefaultStaff(loaded){
  const staff=Object.assign({}, defaults, loaded && typeof loaded==='object' ? loaded : {});
  // Normalize: ensure arrays
  for(const k of Object.keys(staff)){ if(!Array.isArray(staff[k])) staff[k]=[]; }
  return staff;
}

async function loadAll(){
  const c=readCfg();
  if(!c.owner||!c.repo||!c.path||!c.branch||!c.token){
    badge('Not connected','bg-yellow-50 text-yellow-700 border-yellow-300');
    return{staff:defaults,records:[]}
  }
  try{
    const {contentText,sha}=await ghGet(c);
    SHA=sha;
    if(!contentText){
      badge('Connected (file will be created)','bg-blue-50 text-blue-700 border-blue-300');
      return{staff:defaults,records:[]}
    }
    const j=JSON.parse(contentText);
    const staff=withDefaultStaff(j?.staff);
    const records=Array.isArray(j?.records)?j.records:[];
    badge('Connected ✓','bg-green-50 text-green-700 border-green-300');
    return{staff,records}
  }catch(e){
    console.error(e);
    toast('Failed to load from GitHub. Using local defaults.','error');
    badge('Error','bg-red-50 text-red-700 border-red-300');
    return{staff:defaults,records:[]}
  }
}

async function saveAll(next,msg){
  const c=readCfg();
  if(!c.token){toast('Missing GitHub token in Settings.','error');return false}
  try{
    const s=await ghPut(c,JSON.stringify(next,null,2),SHA,msg);
    SHA=s;
    badge('Connected ✓','bg-green-50 text-green-700 border-green-300');
    return true
  }catch(e){
    console.error(e);
    toast('Failed to save to GitHub (see console).','error');
    badge('Error','bg-red-50 text-red-700 border-red-300');
    return false
  }
}

const dd=q('department'), nd=q('name'), lf=q('leaveForm'), tb=q('leaveTableBody'), xb=q('exportButton'),
      df=q('deleteForm'), asf=q('addStaffForm'), asd=q('addStaffDepartment'), nsi=q('newStaffName'),
      rsf=q('removeStaffForm'), rsd=q('removeStaffDepartment'), rsn=q('removeStaffName'),
      openBtn=q('openSettings'), closeBtn=q('closeSettings'), panel=q('settingsPanel'), sf=q('settingsForm'),
      ghO=q('ghOwner'), ghR=q('ghRepo'), ghB=q('ghBranch'), ghP=q('ghPath'), ghT=q('ghToken'),
      testBtn=q('testConnection'), connectBtn=q('connectNow');

const m=q('confirmModal'), mO=q('modalOverlay'), mN=q('modalName'), mD=q('modalDept'), mX=q('modalCancel'), mY=q('modalConfirm'); 
let pending=null;

function namesForDept(){
  const L=data.staff||{}, d=dd.value;
  nd.innerHTML='<option value="">-- Select --</option>';
  (L[d]||[]).forEach(n=>{
    const o=document.createElement('option');o.value=n;o.textContent=n;nd.appendChild(o)
  })
}

function namesForRemove(){
  const L=data.staff||{}, d=rsd.value, arr=(L[d]||[]).slice().sort((a,b)=>a.localeCompare(b));
  rsn.innerHTML='';
  if(!d){rsn.innerHTML='<option value="">-- Select a department first --</option>';return}
  if(!arr.length){rsn.innerHTML='<option value="">(No staff in this department)</option>';return}
  rsn.innerHTML='<option value="">-- Select --</option>';
  arr.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;rsn.appendChild(o)})
}

function draw(records){
  tb.innerHTML='';
  if(!records.length){
    const tr=document.createElement('tr'), td=document.createElement('td');
    td.colSpan=6;td.className='text-center py-4 text-gray-500 italic';td.textContent='No leave records. Add one above!';
    tr.appendChild(td);tb.appendChild(tr);return
  }
  records.forEach(r=>{
    const tr=document.createElement('tr');
    tr.className='bg-white border-b hover:bg-gray-50';
    tr.innerHTML=`<td class="px-6 py-4 text-xs font-mono">${r.id}</td>
      <td class="px-6 py-4">${r.department}</td>
      <td class="px-6 py-4">${r.name}</td>
      <td class="px-6 py-4">${r.date}</td>
      <td class="px-6 py-4">${r.duration}</td>
      <td class="px-6 py-4">${r.shift}</td>`;
    tb.appendChild(tr)
  })
}

function toCSV(rows){
  let s='Record ID,Department,Name,Date,Duration,Shift\n';
  rows.forEach(r=>{s+=`${r.id},"${r.department}","${r.name}","${r.date}","${r.duration}","${r.shift}"\n`});
  return s
}

async function boot(){
  const c=readCfg();
  ghO.value=c.owner;ghR.value=c.repo;ghB.value=c.branch;ghP.value=c.path;ghT.value=c.token;
  data=await loadAll();
  draw(data.records);
  namesForDept();
  namesForRemove()
}

openBtn&&openBtn.addEventListener('click',()=>panel.classList.remove('hidden'));
closeBtn&&closeBtn.addEventListener('click',()=>panel.classList.add('hidden'));

sf&&sf.addEventListener('submit',async e=>{
  e.preventDefault();
  const c={owner:ghO.value.trim(),repo:ghR.value.trim(),branch:(ghB.value.trim()||'main'),path:ghP.value.trim(),token:ghT.value.trim()};
  saveCfg(c);
  toast('Settings saved. Connecting…');
  try{
    const file=await ghGet(c);
    toast(file.contentText?'Connected! File exists.':'Connected! File will be created.');
    badge('Connected ✓','bg-green-50 text-green-700 border-green-300')
  }catch(e){
    console.error(e);
    toast('Connection failed. Check repo/branch/path/token.','error');
    badge('Error','bg-red-50 text-red-700 border-red-300')
  }
  data=await loadAll();
  draw(data.records);
  namesForDept();
  namesForRemove()
});

testBtn&&testBtn.addEventListener('click',async()=>{
  const c=readCfg();
  if(!c.owner||!c.repo||!c.branch||!c.token){
    toast('Fill Owner/Repo/Branch/Token, then Save Settings.','error');panel.classList.remove('hidden');return
  }
  const d=await diagnose(c);
  if(!d.ok){toast(d.msg,'error');badge('Error','bg-red-50 text-red-700 border-red-300');return}
  try{
    const f=await ghGet(c);
    toast(f.contentText?'Connected! File exists.':'Connected! File will be created.');
    badge('Connected ✓','bg-green-50 text-green-700 border-green-300')
  }catch(e){
    console.error(e);
    toast('Could not read contents file (check path).','error');
    badge('Error','bg-red-50 text-red-700 border-red-300')
  }
})

connectBtn&&connectBtn.addEventListener('click',async()=>{
  const cForm={owner:ghO.value.trim(),repo:ghR.value.trim(),branch:(ghB.value||'main').trim(),path:ghP.value.trim(),token:ghT.value.trim()},
        hasAll=cForm.owner&&cForm.repo&&cForm.branch&&cForm.path&&cForm.token,
        c=hasAll?cForm:readCfg();
  if(!c.owner||!c.repo||!c.path||!c.branch||!c.token){
    panel.classList.remove('hidden');toast('Fill all GitHub settings, then Save Settings.','error');return
  }
  saveCfg(c);
  toast('Connecting…');
  const d=await diagnose(c);
  if(!d.ok){toast(d.msg,'error');badge('Error','bg-red-50 text-red-700 border-red-300');return}
  try{
    const f=await ghGet(c);
    toast(f.contentText?'Connected! File exists.':'Connected! File will be created.');
    badge('Connected ✓','bg-green-50 text-green-700 border-green-300');
    data=await loadAll();draw(data.records);namesForDept();namesForRemove()
  }catch(e){
    console.error(e);
    toast('Could not read contents file (check path).','error');
    badge('Error','bg-red-50 text-red-700 border-red-300')
  }
})

dd.addEventListener('change',namesForDept);

lf.addEventListener('submit',async e=>{
  e.preventDefault();
  const name=nd.value, dept=dd.value, date=q('date').value,
        duration=document.querySelector('input[name="leaveDuration"]:checked')?.value,
        shift=document.querySelector('input[name="shift"]:checked')?.value;
  if(!name||!dept||!date||!duration||!shift){toast('Please fill out all fields.','error');return}
  const ym=date.substring(0,7),
        used=data.records.filter(r=>r.name===name&&r.month_year===ym)
          .reduce((t,r)=>t+(parseInt(r.duration,10)||parseInt(r.duration.split(' ')[0],10)),0),
        add=parseInt(duration,10)||parseInt(duration.split(' ')[0],10);
  if(used+add>2){toast(`Monthly limit is 2 hours. ${name} has ${Math.max(0,2-used)} hour(s) left for ${ym}.`,'error');return}
  const rec={id:(crypto?.randomUUID?.()||String(Date.now())),department:dept,name,date,duration,shift,month_year:ym};
  const next={...data,records:[...data.records,rec]};
  if(await saveAll(next,'Add leave record')){data=next;draw(data.records);lf.reset();toast('Leave record added and saved to GitHub!')}
})

df.addEventListener('submit',async e=>{
  e.preventDefault();
  const u=q('deleteUsername').value,p=q('deletePassword').value,id=q('deleteRecordId').value.trim();
  if(u!=='admin'||p!=='damin'){toast('Invalid username or password.','error');return}
  if(!id){toast('Enter a Record ID.','error');return}
  const nextRecs=data.records.filter(r=>r.id!==id);
  if(nextRecs.length===data.records.length){toast('Record not found.','error');return}
  const next={...data,records:nextRecs};
  if(await saveAll(next,'Delete leave record')){data=next;draw(data.records);toast('Leave record deleted and saved to GitHub!')}
})

xb.addEventListener('click',()=>{
  const blob=new Blob([toCSV(data.records)],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='leave_records.csv';
  document.body.appendChild(a);a.click();a.remove();
  toast('CSV exported!')
})

asf.addEventListener('submit',async e=>{
  e.preventDefault();
  const d=asd.value, n=nsi.value.trim();
  if(!d||!n){toast('Select a department and enter a name.','error');return}
  const L=JSON.parse(JSON.stringify(data.staff||{})), arr=L[d]||(L[d]=[]);
  if(arr.includes(n)){toast('This staff member already exists.','error');return}
  arr.push(n);
  const next={...data,staff:L};
  if(await saveAll(next,`Add staff "${n}" to ${d}`)){
    data=next;toast(`${n} added to ${d} and synced to GitHub.`);
    if(q('department').value===d)namesForDept();namesForRemove();nsi.value=''
  }
})

rsd.addEventListener('change',namesForRemove);

rsf.addEventListener('submit',e=>{
  e.preventDefault();
  const d=rsd.value,n=rsn.value;
  if(!d||!n){toast('Select a department and staff member.','error');return}
  pending={dept:d,name:n};
  q('modalName').textContent=n; q('modalDept').textContent=d;
  openModal()
});

function openModal(){m.classList.remove('hidden');m.setAttribute('aria-hidden','false');setTimeout(()=>mY.focus(),0);document.addEventListener('keydown',esc)}
function closeModal(){m.classList.add('hidden');m.setAttribute('aria-hidden','true');document.removeEventListener('keydown',esc)}
function esc(e){if(e.key==='Escape')closeModal()}
mO.addEventListener('click',closeModal); mX.addEventListener('click',closeModal);

mY.addEventListener('click',async()=>{
  if(!pending)return;
  const {dept,name}=pending;
  const L=JSON.parse(JSON.stringify(data.staff||{})), arr=L[dept]||[], i=arr.indexOf(name);
  if(i===-1){toast('Staff not found in department.','error');closeModal();pending=null;return}
  arr.splice(i,1);L[dept]=arr;
  const next={...data,staff:L};
  const ok=await saveAll(next,`Remove staff "${name}" from ${dept}`);
  if(ok){
    data=next;namesForRemove(); if(dd.value===dept)namesForDept();
    toast(`${name} removed from ${dept} and synced to GitHub.`)
  }
  closeModal();pending=null
})

document.readyState==='loading'
  ? document.addEventListener('DOMContentLoaded',()=>boot().catch(console.error))
  : boot().catch(console.error);
</script>
</body>
</html>
