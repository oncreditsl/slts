<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Short Leave Tracking System</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>.kbd{border:1px solid #e5e7eb;border-bottom-width:3px;border-radius:.375rem;padding:.125rem .375rem;font-size:.75rem}</style>
</head>
<body class="bg-gray-100 font-sans p-4 min-h-screen flex items-center justify-center">
<div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-md transition-all duration-300 transform scale-0 opacity-0"></div>

<div class="container mx-auto p-6 md:p-8 bg-white rounded-lg shadow-xl max-w-5xl">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Short Leave Tracking System</h1>
      <p class="text-gray-500 text-sm">Staff lists & records saved to a single JSON file in your GitHub repo.</p>
    </div>
    <div class="flex items-center gap-3">
      <span id="syncBadge" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 border">Not connected</span>
      <button id="connectNow" class="bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700">Connect</button>
      <button id="openSettings" class="bg-gray-800 text-white px-4 py-2 rounded-md font-semibold hover:bg-black">Settings</button>
    </div>
  </div>

  <div id="settingsPanel" class="hidden mb-6 border rounded-lg">
    <div class="p-4 bg-gray-50 border-b flex items-center justify-between">
      <h2 class="text-lg font-semibold">GitHub Settings</h2>
      <button id="closeSettings" class="text-sm text-gray-600 hover:text-gray-900">Close</button>
    </div>
    <form id="settingsForm" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Owner / Org</label>
        <input id="ghOwner" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="e.g. your-username" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Repository</label>
        <input id="ghRepo" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="e.g. short-leave-tracker" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Branch</label>
        <input id="ghBranch" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="e.g. main" value="main" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">App data file path</label>
        <input id="ghPath" class="mt-1 w-full rounded-md border-gray-300 p-2" value="data/app_data.json" required>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">GitHub Personal Access Token (PAT)</label>
        <input id="ghToken" type="password" class="mt-1 w-full rounded-md border-gray-300 p-2" placeholder="Fine-grained token with contents:read,contents:write" required>
        <p class="text-xs text-gray-500 mt-1">Token is kept in <b>sessionStorage</b> and cleared on tab close.</p>
      </div>
      <div class="md:col-span-2 flex justify-end gap-2">
        <button type="button" id="testConnection" class="px-4 py-2 rounded bg-gray-100 border hover:bg-gray-200">Test</button>
        <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Save Settings</button>
      </div>
    </form>
  </div>

  <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add a New Leave Record</h2>
    <form id="leaveForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="department" class="mt-1 block w-full rounded-md border-gray-300 p-2" required></select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <select id="name" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select Department First --</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Date</label>
        <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Duration</label>
        <div class="mt-2 space-y-2">
          <label class="flex items-center"><input name="leaveDuration" type="radio" value="1 hour" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">1 hour</span></label>
          <label class="flex items-center"><input name="leaveDuration" type="radio" value="2 hours" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">2 hours</span></label>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Shift</label>
        <div class="mt-2 space-y-2">
          <label class="flex items-center"><input name="shift" type="radio" value="Morning" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">Morning</span></label>
          <label class="flex items-center"><input name="shift" type="radio" value="Evening" class="h-4 w-4 text-indigo-600 border-gray-300" required><span class="ml-2 text-sm">Evening</span></label>
        </div>
      </div>
      <div class="col-span-1 md:col-span-3 flex flex-wrap justify-end gap-2">
        <button type="button" id="exportButton" class="bg-gray-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-gray-700">Export CSV</button>
        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-indigo-700">Add Record</button>
      </div>
    </form>
  </div>

  <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 px-2">Leave Records</h2>
    <table class="w-full text-sm text-left text-gray-700">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50">
        <tr>
          <th class="px-6 py-3">Record ID</th>
          <th class="px-6 py-3">Department</th>
          <th class="px-6 py-3">Name</th>
          <th class="px-6 py-3">Date</th>
          <th class="px-6 py-3">Duration</th>
          <th class="px-6 py-3">Shift</th>
        </tr>
      </thead>
      <tbody id="leaveTableBody"></tbody>
    </table>
  </div>

  <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Delete a Record</h2>
    <p class="text-sm text-gray-500 mb-4">Use the Record ID from the table above.</p>
    <form id="deleteForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label class="block text-sm font-medium text-gray-700">Record ID</label><input id="deleteRecordId" class="mt-1 w-full rounded-md border-gray-300 p-2" required></div>
      <div><label class="block text-sm font-medium text-gray-700">Username</label><input id="deleteUsername" class="mt-1 w-full rounded-md border-gray-300 p-2" required></div>
      <div><label class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="deletePassword" class="mt-1 w-full rounded-md border-gray-300 p-2" required></div>
      <div class="col-span-1 md:col-span-3 flex justify-end"><button class="bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700">Delete Record</button></div>
    </form>
  </div>

  <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add a New Staff Member</h2>
    <form id="addStaffForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="addStaffDepartment" class="mt-1 block w-full rounded-md border-gray-300 p-2" required></select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700">Staff Name</label><input id="newStaffName" class="mt-1 block w-full rounded-md border-gray-300 p-2" required></div>
      <div class="col-span-1 md:col-span-3 flex justify-end"><button class="bg-gray-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-gray-700">Add Staff</button></div>
    </form>
    <p class="text-xs text-gray-500 mt-3">Staff lists sync to GitHub. Existing leave records stay unchanged.</p>
  </div>

  <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Remove a Staff Member</h2>
    <form id="removeStaffForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="removeStaffDepartment" class="mt-1 block w-full rounded-md border-gray-300 p-2" required></select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Staff Name</label>
        <select id="removeStaffName" class="mt-1 block w-full rounded-md border-gray-300 p-2" required>
          <option value="">-- Select a department first --</option>
        </select>
      </div>
      <div class="col-span-1 md:col-span-3 flex justify-end"><button class="bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700">Remove Staff</button></div>
    </form>
    <p class="text-xs text-gray-500 mt-3">Removal updates the staff list only; it doesn’t delete past records.</p>
  </div>
</div>

<div id="confirmModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div id="modalOverlay" class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-black/5">
      <div class="px-6 pt-6">
        <div class="flex items-start gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mt-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 5v6h-2V7h2zm0 8v2h-2v-2h2z"/></svg>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Remove Staff Member?</h3>
            <p class="mt-1 text-sm text-gray-600">You’re about to remove <span id="modalName" class="font-semibold text-gray-900"></span> from <span id="modalDept" class="font-semibold text-gray-900"></span>.</p>
            <p class="mt-1 text-xs text-gray-500">This will not delete existing leave records.</p>
          </div>
        </div>
      </div>
      <div class="px-6 pb-6 pt-4 flex items-center justify-end gap-2">
        <button id="modalCancel" class="px-4 py-2 rounded-md border bg-white text-gray-700 hover:bg-gray-50">Cancel</button>
        <button id="modalConfirm" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Remove</button>
      </div>
    </div>
  </div>
</div>

<script>
const K={owner:'gh.owner',repo:'gh.repo',path:'gh.path',branch:'gh.branch',token:'gh.token'};
const q=(id)=>document.getElementById(id);
function toast(msg,type='info'){const el=q('messageBox');const base='fixed top-4 left-1/2 -translate-x-1/2 z-50',look='px-4 py-2 rounded-md text-sm text-white shadow-lg border transition-all duration-300 transform max-w-[90vw]',col=
